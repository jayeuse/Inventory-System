<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pharmacy Management - Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="/static/DashboardPage/DashboardPage.css" />
    <link rel="stylesheet" href="/static/utils/notifications.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  </head>
  <body>
    <div class="d-flex">
      <div id="sidebar-container"></div>
      <main class="main flex-grow-1 p-4">
        <div class="tabs">
          <div class="tab active" data-page="dashboard">Dashboard Overview</div>
          <div class="tab" data-page="transactions">Recent Transactions</div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboard_page" class="page-content active">
          <div class="card">
            <!-- Stats Cards Row -->
            <div class="stats-row">
              <div class="stat-card" data-stat="total-products">
                <div class="stat-content">
                  <div class="stat-label">Total Products</div>
                  <div class="stat-value stat-loading" id="dashboard_totalProducts">—</div>
                </div>
                <div class="stat-icon">
                  <i class="bi bi-box-seam"></i>
                </div>
              </div>

              <div class="stat-card" data-stat="pending-orders">
                <div class="stat-content">
                  <div class="stat-label">Pending Orders</div>
                  <div class="stat-value stat-loading" id="dashboard_pendingOrders">—</div>
                </div>
                <div class="stat-icon">
                  <i class="bi bi-clock-history"></i>
                </div>
              </div>
            </div>

            <!-- Charts Row -->
            <div class="charts-row">
              <!-- Pie Chart - Category Distribution -->
              <div class="chart-card">
                <h3 class="chart-title">Products by Category</h3>
                <div class="chart-container">
                  <canvas id="dashboard_categoryChart"></canvas>
                </div>
              </div>

              <!-- Bar Chart - Top Suppliers -->
              <div class="chart-card">
                <h3 class="chart-title">Top 3 Suppliers</h3>
                <div class="chart-container">
                  <canvas id="dashboard_suppliersChart"></canvas>
                </div>
              </div>

              <!-- Donut Chart - Stock Status -->
              <div class="chart-card">
                <h3 class="chart-title">Stock Status</h3>
                <div class="chart-container">
                  <canvas id="dashboard_stockStatusChart"></canvas>
                </div>
              </div>
            </div>

            <!-- Recent Transactions -->
            <div class="recent-section">
              <h3 class="section-title">Recent Transactions</h3>
              <div class="table-wrapper">
                <table class="activity-table" id="dashboard_activityTable">
                  <thead>
                    <tr>
                      <th>Type</th>
                      <th>Product</th>
                      <th>Quantity</th>
                      <th>Date</th>
                    </tr>
                  </thead>
                  <tbody id="dashboard_activityTableBody">
                    <tr>
                      <td><span class="activity-badge badge-in">Stock In</span></td>
                      <td>Biogesic (Paracetamol)</td>
                      <td>500 pieces</td>
                      <td>Oct 21, 2025</td>
                    </tr>
                    <tr>
                      <td><span class="activity-badge badge-out">Stock Out</span></td>
                      <td>Solmux (Carbocisteine)</td>
                      <td>150 pieces</td>
                      <td>Oct 21, 2025</td>
                    </tr>
                    <tr>
                      <td><span class="activity-badge badge-in">Stock In</span></td>
                      <td>Allerkid (Cetirizine)</td>
                      <td>300 boxes</td>
                      <td>Oct 20, 2025</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <!-- Recent Transactions Page (loaded lazily) -->
        <div id="transactions_page" class="page-content"></div>
      </main>
    </div>

    <script>
      // Sidebar initialization
      document.addEventListener("DOMContentLoaded", function () {
        console.log("Initializing dashboard...");

        // Load sidebar component
        fetch("/static/Sidebar/Sidebar.html")
          .then((response) => response.text())
          .then((data) => {
            document.getElementById("sidebar-container").innerHTML = data;
            initializeSidebar();
            initializeTabs();
          })
          .catch((error) => {
            console.error("Error loading sidebar:", error);
          });

        function initializeSidebar() {
          const navIcons = document.querySelectorAll(
            ".sidebar-component .nav-icon"
          );
          const navLabels = document.querySelectorAll(
            ".sidebar-component .nav-label"
          );

          // Remove active class from all items first
          navIcons.forEach((icon) => icon.classList.remove("active"));
          navLabels.forEach((label) => label.classList.remove("active"));

          // Set dashboard as active
          let activeItem = "dashboard";
          console.log("Setting active item:", activeItem);

          const activeIcon = document.querySelector(
            `.sidebar-component .nav-icon[data-item="${activeItem}"]`
          );
          const activeLabel = document.querySelector(
            `.sidebar-component .nav-label[data-item="${activeItem}"]`
          );

          if (activeIcon) {
            activeIcon.classList.add("active");
            console.log("Activated icon:", activeItem);
          }

          if (activeLabel) {
            activeLabel.classList.add("active");
            console.log("Activated label:", activeItem);
          }

          // Add click handlers for navigation
          navIcons.forEach((icon) => {
            icon.addEventListener("click", function () {
              const path = this.getAttribute("data-path");
              const item = this.getAttribute("data-item");

              if (path && item !== "logout") {
                console.log("Navigating to:", path);
                window.location.href = path;
              }
            });
          });

          navLabels.forEach((label) => {
            label.addEventListener("click", function () {
              const path = this.getAttribute("data-path");
              const item = this.getAttribute("data-item");

              if (path && item !== "logout") {
                console.log("Navigating to:", path);
                window.location.href = path;
              }
            });
          });

          // Logout handlers
          const logoutIcon = document.querySelector(
            ".sidebar-component .logout-icon"
          );
          const logoutLabel = document.querySelector(
            ".sidebar-component .logout-label"
          );

          if (logoutIcon) {
            logoutIcon.addEventListener("click", function () {
              console.log("Logout clicked from icon");
              // Redirect to the login page
              window.location.href = '/login/';
            });
          }

          if (logoutLabel) {
            logoutLabel.addEventListener("click", function () {
              console.log("Logout clicked from label");
              // Redirect to the login page
              window.location.href = '/login/';
            });
          }

          // Sync hover states between icons and labels
          navIcons.forEach((icon) => {
            const item = icon.getAttribute("data-item");

            icon.addEventListener("mouseenter", function () {
              const label = document.querySelector(
                `.sidebar-component .nav-label[data-item="${item}"]`
              );
              if (label && !label.classList.contains("active")) {
                label.style.backgroundColor = "var(--white)";
                label.style.color = "var(--violet-medium)";
              }
            });

            icon.addEventListener("mouseleave", function () {
              const label = document.querySelector(
                `.sidebar-component .nav-label[data-item="${item}"]`
              );
              if (label && !label.classList.contains("active")) {
                label.style.backgroundColor = "";
                label.style.color = "";
              }
            });
          });

          navLabels.forEach((label) => {
            const item = label.getAttribute("data-item");

            label.addEventListener("mouseenter", function () {
              const icon = document.querySelector(
                `.sidebar-component .nav-icon[data-item="${item}"]`
              );
              if (icon && !icon.classList.contains("active")) {
                icon.style.backgroundColor = "var(--white)";
                icon.style.color = "var(--violet-darker)";
              }
            });

            label.addEventListener("mouseleave", function () {
              const icon = document.querySelector(
                `.sidebar-component .nav-icon[data-item="${item}"]`
              );
              if (icon && !icon.classList.contains("active")) {
                icon.style.backgroundColor = "";
                icon.style.color = "";
              }
            });
          });
        }

        // Tabs: switch pages and lazy-load Recent Transactions
        function initializeTabs() {
          const tabs = document.querySelectorAll('.tabs .tab');
          const pages = document.querySelectorAll('.page-content');

          tabs.forEach(tab => {
            tab.addEventListener('click', () => {
              const target = tab.getAttribute('data-page');

              // Toggle active classes
              tabs.forEach(t => t.classList.remove('active'));
              pages.forEach(p => p.classList.remove('active'));
              tab.classList.add('active');

              const pageEl = document.getElementById(target + '_page');
              if (pageEl) pageEl.classList.add('active');

              // If Recent Transactions page, load content lazily
              if (target === 'transactions' && pageEl && !pageEl.dataset.loaded) {
                loadRecentTransactions(pageEl);
              }
            });
          });
        }

        function loadRecentTransactions(container) {
          fetch('/static/DashboardPage/RecentTransaction.html')
            .then(r => r.text())
            .then(html => {
              try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const content = doc.getElementById('transactions-content') || doc.querySelector('main');
                if (!content) {
                  container.innerHTML = html;
                } else {
                  container.innerHTML = content.innerHTML;
                }

                // Load page-specific CSS (if any)
                const cssHref = '/static/DashboardPage/RecentTransaction.css';
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = cssHref;
                document.head.appendChild(link);

                // Load page-specific JS
                const script = document.createElement('script');
                script.src = '/static/DashboardPage/RecentTransaction.js';
                document.body.appendChild(script);

                // If the manager is included statically (deferred), invoke its loader now
                try {
                  if (window.RecentTransactionsManagement && typeof window.RecentTransactionsManagement.loadAndRender === 'function') {
                    window.RecentTransactionsManagement.loadAndRender();
                  } else {
                    // fallback: attempt shortly in case the script is still loading
                    setTimeout(() => { window.RecentTransactionsManagement?.loadAndRender?.(); }, 100);
                  }
                } catch (err) {
                  console.error('Error invoking RecentTransactionsManagement after static load', err);
                }

                // Mark as loaded (content injected); the manager will populate the timeline on script load
                container.dataset.loaded = '1';
              } catch (err) {
                console.error('Failed to parse recent transactions HTML', err);
                container.innerHTML = html;
              }
            })
            .catch(err => {
              console.error('Error loading recent transactions:', err);
              container.innerHTML = '<div class="card"><div class="card-body">Failed to load recent transactions.</div></div>';
            });
        }

        // Initialize Charts
        initializeCharts();
        // Populate the compact dashboard activity table
        loadDashboardRecentActivity();
      });

      async function loadDashboardRecentActivity() {
        const tbody = document.getElementById('dashboard_activityTableBody');
        if (!tbody) return;
        try {
          const url = '/api/transactions/?page_size=5';
          const res = await fetch(url, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': (typeof getCSRFToken === 'function') ? getCSRFToken() : ''
            }
          });
          if (!res.ok) return;
          const data = await res.json();
          const items = Array.isArray(data) ? data : (data.results || []);
          // Build rows
          tbody.innerHTML = items.map(t => {
            const qtyRaw = t.quantity_change != null ? String(t.quantity_change) : '0';
            const parsed = Number(qtyRaw.replace(/[^0-9\-\.\+]/g, ''));
            const hasNumeric = !isNaN(parsed) && parsed !== 0;
            const direction = hasNumeric ? (parsed > 0 ? 'in' : 'out') : (String(t.transaction_type || '').toLowerCase().includes('in') ? 'in' : 'out');
            const badgeClass = direction === 'in' ? 'activity-badge badge-in' : 'activity-badge badge-out';
            const badgeText = direction === 'in' ? 'Stock In' : 'Stock Out';
            const isAdjustment = String(t.transaction_type || '').toLowerCase().includes('adj') || String(t.transaction_type || '').toLowerCase().includes('adjust');
            const qtyDisplay = qtyRaw.replace(/^\+/, '');
            // Date formatting: try native, fallback to raw
            let dateText = '';
            try {
              const d = new Date(t.date_of_transaction);
              if (!isNaN(d)) dateText = d.toLocaleDateString();
              else dateText = String(t.date_of_transaction).split(',')[0] || String(t.date_of_transaction);
            } catch (e) {
              dateText = String(t.date_of_transaction);
            }

            return `<tr>
                      <td><span class="${badgeClass}">${badgeText}</span></td>
                      <td>${(t.product_name || t.product_id || '-')}</td>
                      <td>${qtyDisplay}</td>
                      <td>${dateText}</td>
                    </tr>`;
          }).join('');
        } catch (err) {
          console.error('Failed to load dashboard recent activity', err);
        }
      }

      function initializeCharts() {
        // Category Pie Chart
        const dashboard_categoryCtx = document.getElementById("dashboard_categoryChart");
        const dashboard_categoryChart = new Chart(dashboard_categoryCtx, {
          type: "pie",
          data: {
            labels: [
              "Analgesics/Antipyretics",
              "Antibiotics",
              "Antihistamines",
              "First Aid Supplies",
              "Antiseptics",
              "Vitamins & Supplements"
            ],
            datasets: [
              {
                data: [3250, 2100, 1850, 1200, 980, 750],
                backgroundColor: [
                  "#8b5fbf",
                  "#6c9bcf",
                  "#ff9e9e",
                  "#ffd166",
                  "#06d6a0",
                  "#b8a9d1"
                ],
                borderWidth: 2,
                borderColor: "#ffffff"
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: true,
                position: "bottom",
                labels: {
                  padding: 8,
                  font: {
                    size: 10,
                    family: "'Poppins', sans-serif"
                  },
                  usePointStyle: true,
                  pointStyle: "circle",
                  boxWidth: 6
                }
              },
              tooltip: {
                backgroundColor: "rgba(0, 0, 0, 0.8)",
                padding: 10,
                titleFont: {
                  size: 12,
                  weight: "600"
                },
                bodyFont: {
                  size: 11
                },
                callbacks: {
                  label: function (context) {
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                    return `${context.parsed.toLocaleString()} units (${percentage}%)`;
                  }
                }
              }
            }
          }
        });

        // Top Suppliers Bar Chart
        const dashboard_suppliersCtx = document.getElementById("dashboard_suppliersChart");
        const dashboard_suppliersChart = new Chart(dashboard_suppliersCtx, {
          type: "bar",
          data: {
            labels: ["MedSupply Corp", "PharmaDirect Inc", "HealthCare Partners"],
            datasets: [
              {
                label: "Products Supplied",
                data: [450, 380, 320],
                backgroundColor: [
                  "rgba(139, 95, 191, 0.8)",
                  "rgba(108, 155, 207, 0.8)",
                  "rgba(255, 158, 158, 0.8)"
                ],
                borderColor: [
                  "rgba(139, 95, 191, 1)",
                  "rgba(108, 155, 207, 1)",
                  "rgba(255, 158, 158, 1)"
                ],
                borderWidth: 2,
                borderRadius: 8
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: "rgba(0, 0, 0, 0.05)"
                },
                ticks: {
                  font: {
                    size: 10
                  },
                  padding: 5
                }
              },
              x: {
                grid: {
                  display: false
                },
                ticks: {
                  font: {
                    size: 10,
                    weight: "500"
                  },
                  padding: 5
                }
              }
            },
            layout: {
              padding: {
                top: 10,
                bottom: 5
              }
            },
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                backgroundColor: "rgba(0, 0, 0, 0.8)",
                padding: 10,
                titleFont: {
                  size: 12,
                  weight: "600"
                },
                bodyFont: {
                  size: 11
                },
                callbacks: {
                  label: function (context) {
                    return `Products: ${context.parsed.y}`;
                  }
                }
              }
            }
          }
        });

        // Stock Status Donut Chart
        const dashboard_stockStatusCtx = document.getElementById("dashboard_stockStatusChart");
        const dashboard_stockStatusChart = new Chart(dashboard_stockStatusCtx, {
          type: "doughnut",
          data: {
            labels: ["Normal", "Low Stock", "Out of Stock", "Near Expiry", "Expired"],
            datasets: [
              {
                data: [856, 124, 35, 89, 18],
                backgroundColor: [
                  "#06d6a0",  // Normal - Green
                  "#ffd166",  // Low Stock - Yellow
                  "#94a3b8",  // Out of Stock - Gray
                  "#ff9e9e",  // Near Expiry - Light Red
                  "#ef4444"   // Expired - Red
                ],
                borderWidth: 2,
                borderColor: "#ffffff"
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            cutout: "70%",
            plugins: {
              legend: {
                display: true,
                position: "bottom",
                labels: {
                  padding: 8,
                  font: {
                    size: 10,
                    weight: "500"
                  },
                  usePointStyle: true,
                  pointStyle: "circle",
                  boxWidth: 6
                }
              },
              tooltip: {
                backgroundColor: "rgba(0, 0, 0, 0.8)",
                padding: 10,
                titleFont: {
                  size: 12,
                  weight: "600"
                },
                bodyFont: {
                  size: 11
                },
                callbacks: {
                  label: function (context) {
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                    return `${context.label}: ${context.parsed} batches (${percentage}%)`;
                  }
                }
              }
            }
          }
        });
        
        // Store chart instances for backend updates
        dashboard_setChartInstances(dashboard_categoryChart, dashboard_suppliersChart, dashboard_stockStatusChart);
      }
    </script>
    <script src="/static/utils/notifications.js"></script>
    <script src="/static/utils/csrf.js"></script>
    <script src="/static/utils/currency.js"></script>
    <script src="/static/utils/permissions.js"></script>
    <script src="/static/SettingsPage/LogoutManagement/LogoutManagement.js"></script>
    <script src="/static/DashboardPage/DashboardPage.js"></script>
    <script src="/static/DashboardPage/ChartsManagement/ChartsManagement.js" defer></script>
    <script src="/static/DashboardPage/RecantTransationsManagement/RecentTransactionsManagement.js" defer></script>
  </body>
</html>
